



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Notes about various topics, courses, books, etc.">
      
      
        <link rel="canonical" href="https://marcolabarile.me/notes/oauth2-and-openid-connect/openid-connect/">
      
      
        <meta name="author" content="Marco Labarile">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon-16x16.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>OpenID Connect - Marco Labarile - Notes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.1b62728e.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
      <script src="../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../assets/styles/extra.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-117745201-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="green" data-md-color-accent="green">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#openid-connect" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://marcolabarile.me/notes/" title="Marco Labarile - Notes" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Marco Labarile - Notes
            </span>
            <span class="md-header-nav__topic">
              
                OpenID Connect
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/labarilem/notes" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    labarilem/notes
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://marcolabarile.me/notes/" title="Marco Labarile - Notes" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Marco Labarile - Notes
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/labarilem/notes" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    labarilem/notes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      OAuth 2.0 and OpendID Connect
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        OAuth 2.0 and OpendID Connect
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../jwt/" title="JWT (JSON Web Token)" class="md-nav__link">
      JWT (JSON Web Token)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../oauth2/" title="OAuth 2.0" class="md-nav__link">
      OAuth 2.0
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        OpenID Connect
      </label>
    
    <a href="./" title="OpenID Connect" class="md-nav__link md-nav__link--active">
      OpenID Connect
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#purpose" class="md-nav__link">
    Purpose
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#endpoints" class="md-nav__link">
    Endpoints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scopes" class="md-nav__link">
    Scopes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#id-tokens" class="md-nav__link">
    Id Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flows" class="md-nav__link">
    Flows
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authorization-code-flow" class="md-nav__link">
    Authorization code flow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implicit-flow" class="md-nav__link">
    Implicit flow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hybrid-flow" class="md-nav__link">
    Hybrid flow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#which-flow-should-you-use" class="md-nav__link">
    Which flow should you use?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vulnerabilities-and-attacks" class="md-nav__link">
    Vulnerabilities and attacks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replay-attack" class="md-nav__link">
    Replay attack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-resources" class="md-nav__link">
    More resources
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Building microservices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Building microservices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/microservices/" title="Microservices" class="md-nav__link">
      Microservices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/evolutionary-architects/" title="Evolutionary architects" class="md-nav__link">
      Evolutionary architects
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/how-to-model-services/" title="How to model services" class="md-nav__link">
      How to model services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/integration/" title="Integration" class="md-nav__link">
      Integration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/splitting-the-monolith/" title="Splitting the monolith" class="md-nav__link">
      Splitting the monolith
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/deployment/" title="Deployment" class="md-nav__link">
      Deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/testing/" title="Testing" class="md-nav__link">
      Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/monitoring/" title="Monitoring" class="md-nav__link">
      Monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/security/" title="Security" class="md-nav__link">
      Security
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/conway/" title="Conway's Law and System Desing" class="md-nav__link">
      Conway's Law and System Desing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/microservices-at-scale/" title="Microservices at Scale" class="md-nav__link">
      Microservices at Scale
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../building-microservices/conclusion/" title="Bringing It All Together" class="md-nav__link">
      Bringing It All Together
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Bitcoin and cryptocurrency technologies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Bitcoin and cryptocurrency technologies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/crypto-hash-functions/" title="Cryptographic hash functions" class="md-nav__link">
      Cryptographic hash functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/digital-signature/" title="Digital signature" class="md-nav__link">
      Digital signature
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/hash-pointers-and-data-structures/" title="Hash pointers" class="md-nav__link">
      Hash pointers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/centralization-vs-decentralization/" title="Centralization and decentralization" class="md-nav__link">
      Centralization and decentralization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/distributed-consensus/" title="Distributed consensus" class="md-nav__link">
      Distributed consensus
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#purpose" class="md-nav__link">
    Purpose
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#endpoints" class="md-nav__link">
    Endpoints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scopes" class="md-nav__link">
    Scopes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#id-tokens" class="md-nav__link">
    Id Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flows" class="md-nav__link">
    Flows
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authorization-code-flow" class="md-nav__link">
    Authorization code flow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implicit-flow" class="md-nav__link">
    Implicit flow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hybrid-flow" class="md-nav__link">
    Hybrid flow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#which-flow-should-you-use" class="md-nav__link">
    Which flow should you use?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vulnerabilities-and-attacks" class="md-nav__link">
    Vulnerabilities and attacks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replay-attack" class="md-nav__link">
    Replay attack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-resources" class="md-nav__link">
    More resources
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="openid-connect">OpenID Connect<a class="headerlink" href="#openid-connect" title="Permanent link">&para;</a></h1>
<p>OpenID Connect (<em>OIDC</em>) is an authentication protocol. It builds upon <a href="../oauth2/">OAuth 2.0</a> and <a href="./">JSON Web Tokens</a> to provide users one login for multiple sites.</p>
<p>For example, Trello lets you create a new account using an existing Google account. In this case, Trello only needs to access some basic information of your Google account (e.g. email and username). The main advantage is that <em>you don't need to share your Google password with Trello</em>. This is possible because Trello can use OpenID Connect tokens to validate your Google account identity.</p>
<p>In the following sections we will go through the main concepts of the OpenID Connect protocol.</p>
<h2 id="purpose">Purpose<a class="headerlink" href="#purpose" title="Permanent link">&para;</a></h2>
<p>Sometimes you need only an authentication mechanism, without any authorization logic. But OAuth 2.0 is not good enough by itself to be used for authentication. Let's see why by examining how authentication could be implemented with OAuth 2.0:</p>
<p>We could use a custom OAuth 2.0 <a href="../oauth2/#scopes">scope</a> named <em>signin</em> that represents the permission to access the basic information of the user. The idea is: <em>if the user is able to grant us that token, then surely he must have authenticated</em>. But there are some problems with this approach:</p>
<ul>
<li>The authentication step made by the user is not correlated to the authorization request.</li>
<li>The user data endpoint is usually different for each service (e.g. Google may have a different endpoint from Facebook).</li>
</ul>
<p>In fact, this usage of OAuth 2.0 is vulnerable to a very simple yet dangerous impersonification attack: if a malicious application has been granted access to your user data, it can reuse the same <em>access_token</em> to authenticate as you to another service (e.g. e-banking) using the same authentication mechanism.</p>
<p>With this approach, providers using OAuth 2.0 for authentication would need to implement extra security measures. But this measure may not be standardized across different providers! This means software developers would need to write different code to authenticate to different providers.</p>
<p>So, in order to make OAuth 2.0 suitable for authentication we need:</p>
<ul>
<li>A new token type which can be validated in a standardized way.</li>
<li>A standardized mechanism to access the user's information.</li>
</ul>
<p>This is exactly what OpenID Connect provides on top of OAuth 2.0, with the help of JWT.</p>
<h2 id="endpoints">Endpoints<a class="headerlink" href="#endpoints" title="Permanent link">&para;</a></h2>
<p>Endpoints are URIs that define the location of authentication services. In OpenID Connect, there are 3 endpoints:</p>
<ul>
<li>The Authorization endpoint is usually on the authorization server. It's used to perform authentication of the user.</li>
<li>The Token endpoint is usually on the authorization server. This is where the client application exchanges some secret information for an access token, <a href="#id-tokens">ID token</a> and optionally a refresh token.</li>
<li>The UserInfo endpoint is usually on the authorization server. It's used to retrieve claims about the currently authenticated user.</li>
</ul>
<p>This is how the OpenID Connect endpoints would be translated in our Trello example:</p>
<p><img alt="OpenID Connect endpoints example" class="center" src="../images/oidc-endpoints.svg" /></p>
<h2 id="scopes">Scopes<a class="headerlink" href="#scopes" title="Permanent link">&para;</a></h2>
<p>OAuth 2.0 scopes in OpenID Connect are used to define to which <a href="#id-tokens">ID token</a> claims the client is requesting access.</p>
<p>The OpenID Connect specification defines a set of <a href="https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims">standard scopes</a>. The only required scope is <em>openid</em>, which states that the client intends to use the OpenId Connect protocol.</p>
<h2 id="id-tokens">Id Tokens<a class="headerlink" href="#id-tokens" title="Permanent link">&para;</a></h2>
<p>ID Tokens are JWTs introduced by OpenID Connect that contain identity data. An ID Token can be returned in a token response, alongside an <em>access_token</em>. It can be consumed by the application and it also contains user information (e.g. username, email).</p>
<p>The OpenID Connect specification defines a set of <a href="https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims">standard claims</a>. Still, it's possible to define custom claims and add them to your tokens.</p>
<h2 id="flows">Flows<a class="headerlink" href="#flows" title="Permanent link">&para;</a></h2>
<p>The OpenID Connect specification defines 3 authentication flows:</p>
<ul>
<li><a href="#authorization-code-flow">Authorization code flow</a></li>
<li><a href="#implicit-flow">Implicit flow</a></li>
<li><a href="#hybrid-flow">Hybrid flow</a></li>
</ul>
<h3 id="authorization-code-flow">Authorization code flow<a class="headerlink" href="#authorization-code-flow" title="Permanent link">&para;</a></h3>
<p>The <a href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth">Authorization code flow</a> has been designed for clients which can securely store a client secret. This grant is typically used when the client is a web server.</p>
<p>Here's how the Authorization code flow would work in our Trello example:</p>
<p><img alt="OpenID Connect Authentication code flow" class="center" src="../images/oidc-code-flow.svg" /></p>
<ol>
<li>The user clicks on a button in the Trello's web app in order to login with his Google account to Trello.</li>
<li>The Trello web app requests an authorization code. This operation can be done in several ways (e.g. redirection, link on HTML button). The code can be retrieved by making a HTTP GET request to the Google account's <em>authorization</em> endpoint with these parameters:<ul>
<li><strong>client_id</strong>: the public id of the client. This was determined by the authorization server when the client was registered.</li>
<li><strong>response_type</strong>: specifies the grant type. By setting this parameter to <em>code</em>, the client indicates that it wants to start an authorization code flow.</li>
<li><strong>state</strong>: used to prevent <a href="../oauth2/#authorization-code-csrf">CSRF attacks</a>.</li>
<li><strong>redirect_uri</strong>: this is where the user will be sent after he approves the permission request.</li>
<li><strong>scope</strong>: describes the scope of the authorization. By setting this parameter to <em>openid+...</em>, the client specifies that it intends to start an OpenID Connect authorization code flow.</li>
</ul>
</li>
<li>The Google account server responds with the consent screen page.</li>
<li>The user examines the requested permissions in the consent screen and then gives consent to Trello.</li>
<li>The Google account server redirects the user to the <em>redirect_uri</em> on the client with these parameters:<ul>
<li><strong>code</strong>: the authorization code.</li>
<li><strong>state</strong>: the state that was previously set for this authentication request.</li>
</ul>
</li>
<li>Trello now has the authorization code and exchanges it for the access token and ID token for the user's Google account by making a HTTP POST request:<ul>
<li><strong>code</strong>: the authorization code.</li>
<li><strong>grant_type</strong>: specifies the grant type. By setting this parameter to <em>authorization_code</em>, the client indicates that it wants to complete an authorization code grant.</li>
<li><strong>redirect_uri</strong>: the uri where the authorization code has been previously sent.</li>
<li><strong>client_id</strong>: the public id of the client. This was determined by the authorization server when the client was registered.</li>
<li><strong>client_secret</strong>: the private secret stored by the client. It was associated by the authorization server to the <em>client_id</em> when the client was registered.</li>
</ul>
</li>
<li>Trello now <a href="./jwt#how-to-validate-a-jwt">validates</a> the ID token. If the validation succeeds, Trello can be sure that the token it received was actually intended for its client. This solves the impersonification attack we've discussed <a href="#purpose">earlier</a>.</li>
<li>If Trello needs more user information than the one included in the Id token, it can contact the UserInfo endpoint on the authorization server.</li>
<li>The UserInfo endpoint on the authorization server responds in a standardized format.</li>
</ol>
<h3 id="implicit-flow">Implicit flow<a class="headerlink" href="#implicit-flow" title="Permanent link">&para;</a></h3>
<p>The <a href="https://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth">Implicit flow</a> has been designed to immediately return an access token to the client, without first performing a code exchange.</p>
<p>It is mainly used by web browser applications without a server. The Access Token and ID Token are returned directly to the client, which may expose them to the user and other applications that have access to the client.</p>
<p>Here's how the Implicit flow would work in our Trello example:</p>
<p><img alt="OpenID Connect Implicit flow" class="center" src="../images/oidc-implicit-flow.svg" /></p>
<ol>
<li>The user clicks on a button in the Trello's web app in order to login with his Google account to Trello.</li>
<li>The Trello web app requests the ID token. It can be retrieved by making a HTTP GET request to the Google account's <em>authorization</em> endpoint with these parameters:<ul>
<li><strong>client_id</strong>: the public id of the client. This was determined by the authorization server when the client was registered.</li>
<li><strong>response_type</strong>: specifies the grant type. By setting this parameter to <em>id_token+token</em>, the client indicates that it wants to start an OpenID Connect Implicit flow that returns an ID token and an access token.</li>
<li><strong>state</strong>: used to prevent <a href="../oauth2/#authorization-code-csrf">CSRF attacks</a>.</li>
<li><strong>redirect_uri</strong>: this is where the user will be sent after he authenticates.</li>
<li><strong>scope</strong>: describes the scope of the authorization. By setting this parameter to <em>openid+...</em>, the client specifies that it intends to start an OpenID Connect authorization code flow.</li>
<li><strong>nonce</strong>: associates a client session with an ID token in order to mitigate <a href="#replay-attack">replay attacks</a>. It's a mandatory parameter in the OpenID Connect implicit flow.</li>
</ul>
</li>
<li>The Google account server responds with the consent screen page.</li>
<li>The user examines the requested permissions in the consent screen and then gives consent to Trello.</li>
<li>The Google account server redirects the user to the <em>redirect_uri</em> on the client. This URL uses the hash character (<em>#</em>) to specify parameters so that they are not sent to the server. These are the parameters received by the client:<ul>
<li><strong>access_token</strong>: the OAuth 2.0 access token.</li>
<li><strong>id_token</strong>: the OpenID Connect ID token.</li>
<li><strong>token_type</strong>: set to <em>Bearer</em> to indicate that the access token must be used with the Bearer scheme.</li>
<li><strong>expires_in</strong>: the lifespan of the access token.</li>
<li><strong>state</strong>: the state that was previously set for this authorization request. The client needs to verify this match before using the access token to avoid malicious token injections.</li>
</ul>
</li>
<li>The Trello web app now <a href="./jwt#how-to-validate-a-jwt">validates</a> the ID token. Also, the value of the <em>nonce</em> claim must be checked to verify that it is the same value as the one that was sent in the authentication request. If the validation succeeds, the Trello web app can be sure that the token it received was actually intended for its client. This solves the impersonification attack we've discussed <a href="#purpose">earlier</a>.</li>
<li>If the Trello web app needs more user information than the one included in the Id token, it can contact the UserInfo endpoint on the authorization server.</li>
<li>The UserInfo endpoint on the authorization server responds in a standardized format.</li>
</ol>
<h3 id="hybrid-flow">Hybrid flow<a class="headerlink" href="#hybrid-flow" title="Permanent link">&para;</a></h3>
<p>The <a href="https://openid.net/specs/openid-connect-core-1_0.html#HybridFlowAuth">Hybrid flow</a> combines mechanisms of the <a href="#authorization-code-flow">Authorization code flow</a> and <a href="#implicit-flow">Implicit flow</a>. It allows the front end and back end of the application to receive their own tokens, with their own scopes.</p>
<p>The Hybrid flow has three possible variations. To use a specific variation, set the <em>response_type</em> parameter to one of these values:</p>
<ul>
<li><em>code id_token</em></li>
<li><em>code token</em></li>
<li><em>code id_token token</em></li>
</ul>
<p>These notes won't contain the details of the Hybrid flow because it's rarely used in practice.</p>
<h3 id="which-flow-should-you-use">Which flow should you use?<a class="headerlink" href="#which-flow-should-you-use" title="Permanent link">&para;</a></h3>
<p>Now we understand which are the the available flows in the OpenID Connect specification.</p>
<p>So, <em>which flow should you use for your application</em>? The following flow chart answer this question:</p>
<p><img alt="OpenId Connect which flow to use" class="center" src="../images/oidc-which-flow-to-use.svg" /></p>
<h2 id="vulnerabilities-and-attacks">Vulnerabilities and attacks<a class="headerlink" href="#vulnerabilities-and-attacks" title="Permanent link">&para;</a></h2>
<p>There are some known attacks that can exploit vulnerable implementations of OpenID Connect. In this section we will go through some of the most known OpenID Connect attacks.</p>
<h3 id="replay-attack">Replay attack<a class="headerlink" href="#replay-attack" title="Permanent link">&para;</a></h3>
<p>When we're using the OpenID Connect Implicit flow in a web browser app without server, the <em>nonce</em> parameter is a fundamental security measure.</p>
<p>Let's suppose that, in our example, the Trello web app is not using a nonce parameter. Here's a <a href="https://en.wikipedia.org/wiki/Replay_attack">replay attack</a> that can be carried out in this situation:</p>
<ol>
<li>The Trello web app redirects the user to the authentication server with a <em>response_type</em> of <em>id_token</em>.</li>
<li>The user authenticates and gives his consent.</li>
<li>Google Account redirects the user back to the Trello web app with an <em>id_token</em>.</li>
<li>An attacker is able to get the response URL in some way (e.g. via packet sniffing).</li>
<li>The attacker pastes the response URL into their browser's URL bar, effectively authenticating as the original user.</li>
</ol>
<p>Instead, a canonical implementation of OpenID Connect would mandate handling the nonce in this way:</p>
<ol>
<li>The Trello web app generates a cryptographically secure random nonce and stores in clear text, for example in the browser's local storage.</li>
<li>The Trello web app hashes the nonce and sends the hash as the value of the <em>nonce</em> parameter in the authentication request.</li>
<li>When the Trello web app receives the authentication response, it reads and then removes the nonce from the persistent storage, hashes it, and compares it against the hashed nonce in the id_token. If they don't match, then the client application refuses to establish identity.</li>
</ol>
<p>By using the nonce, even if the attacker intercepts the response, he would still need the clear-text nonce to authenticate with the Trello web app.</p>
<h2 id="more-resources">More resources<a class="headerlink" href="#more-resources" title="Permanent link">&para;</a></h2>
<p>If you want to learn more about OpenID Connect, you can consult these resources:</p>
<ul>
<li><a href="https://openid.net/">OpenID Foundation's website</a></li>
<li><a href="https://openid.net/developers/specs/">Comprehensive list of OpenID Connect specifications</a></li>
</ul>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../oauth2/" title="OAuth 2.0" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                OAuth 2.0
              </span>
            </div>
          </a>
        
        
          <a href="../../building-microservices/" title="Home" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Home
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/labarilem" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://www.linkedin.com/in/marcolabarile/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>